#!/bin/bash
# Pre-commit hook - runs full validation before commits

set -e

echo "ğŸ” Running full validation before commit..."

# Nix files
echo "ğŸ“ Formatting all .nix files..."
if command -v treefmt >/dev/null 2>&1; then
	treefmt
	echo "âœ… All .nix files formatted"
else
	echo "âš ï¸  treefmt not found in PATH"
fi

echo "ğŸ” Running statix checks..."
if command -v statix >/dev/null 2>&1; then
	statix check
	echo "âœ… Statix checks passed"
else
	echo "âš ï¸  statix not found in PATH"
fi

echo "ğŸ§¹ Running deadnix checks..."
if command -v deadnix >/dev/null 2>&1; then
	deadnix
	echo "âœ… Deadnix checks passed"
else
	echo "âš ï¸  deadnix not found in PATH"
fi

# Markdown files
echo "ğŸ“ Checking markdown files..."
if command -v markdownlint >/dev/null 2>&1; then
	fd -e md -x markdownlint 2>/dev/null || true
	echo "âœ… Markdown checks completed"
else
	echo "âš ï¸  markdownlint not found in PATH"
fi

# Shell scripts (by directory)
echo "ğŸš Checking shell scripts..."
script_dirs=("bin" "scripts" ".claude/hooks")
for dir in "${script_dirs[@]}"; do
	if [[ -d "$dir" ]]; then
		echo "  Checking scripts in $dir/..."

		# Format with shfmt
		if command -v shfmt >/dev/null 2>&1; then
			shfmt -w "$dir"/* 2>/dev/null || true
		fi

		# Check with shellcheck
		if command -v shellcheck >/dev/null 2>&1; then
			shellcheck "$dir"/* 2>/dev/null || true
		fi

		# Harden with shellharden
		if command -v shellharden >/dev/null 2>&1; then
			for file in "$dir"/*; do
				if [[ -f "$file" ]]; then
					shellharden --replace "$file" 2>/dev/null || true
				fi
			done
		fi
	fi
done
echo "âœ… Shell script checks completed"

# Nix flake check
echo "ğŸ—ï¸  Running nix flake check..."
if command -v nix >/dev/null 2>&1; then
	nix flake check
	echo "âœ… Nix flake check passed"
else
	echo "âš ï¸  nix command not found in PATH"
fi

echo "ğŸ‰ All validation checks passed!"
