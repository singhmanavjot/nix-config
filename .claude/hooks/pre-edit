#!/bin/bash
# Pre-edit hook - runs validation before editing files

set -e

file="$1"

# Function to check if file is a shell script
is_shell_script() {
	local file="$1"
	# Check by directory location
	if [[ "$file" == */bin/* ]] || [[ "$file" == */scripts/* ]] || [[ "$file" == */.claude/hooks/* ]]; then
		return 0
	fi
	# Check by shebang
	if [[ -f "$file" ]] && head -1 "$file" 2>/dev/null | rg -q '^#!/.*sh'; then
		return 0
	fi
	return 1
}

# Nix files
if [[ "$file" == *.nix ]]; then
	echo "🔍 Running Nix validation before edit..."

	# Check for basic syntax issues with statix
	if command -v statix >/dev/null 2>&1; then
		statix check "$file" || true
	fi

	# Check for dead code with deadnix
	if command -v deadnix >/dev/null 2>&1; then
		deadnix "$file" || true
	fi

# Markdown files
elif [[ "$file" == *.md ]]; then
	echo "📝 Running Markdown validation before edit..."

	# Check markdown with markdownlint
	if command -v markdownlint >/dev/null 2>&1; then
		markdownlint "$file" || true
	fi

# Shell scripts
elif is_shell_script "$file"; then
	echo "🐚 Running shell script validation before edit..."

	# Check with shellcheck
	if command -v shellcheck >/dev/null 2>&1; then
		shellcheck "$file" || true
	fi
fi
